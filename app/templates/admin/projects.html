{% extends "base.html" %}

{% block title %}All Projects - Admin{% endblock %}

{% block content %}
<h1>All Projects</h1>

<div style="margin-bottom: 1.5rem;">
    <a href="{{ url_for('user_admin.dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

<div class="card">
    <h2>System-wide Projects ({{ projects|length }})</h2>
    
    {% if projects %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Project Name</th>
                <th>Owner</th>
                <th>Client</th>
                <th>Project Number</th>
                <th>Region</th>
                <th>Type</th>
                <th>Beams</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
            <tr>
                <td>{{ project.id }}</td>
                <td><strong>{{ project.name }}</strong></td>
                <td>
                    <a href="{{ url_for('user_admin.users') }}#user-{{ project.user_id }}">
                        {{ project.owner.username }}
                    </a>
                </td>
                <td>{{ project.client or '-' }}</td>
                <td>{{ project.project_number or '-' }}</td>
                <td>{{ project.region or '-' }}</td>
                <td>{{ project.project_type or '-' }}</td>
                <td>{{ project.beams.count() }}</td>
                <td>{{ project.created_at.strftime('%Y-%m-%d') }}</td>
                <td>
                    <a href="{{ url_for('projects.detail', project_id=project.id) }}" 
                       class="btn btn-primary btn-sm">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #666; padding: 2rem;">No projects in the system yet.</p>
    {% endif %}
</div>

<div class="card" style="margin-top: 2rem;">
    <h3>Projects by User</h3>
    {% set users_with_projects = projects|groupby('owner.username') %}
    {% if users_with_projects %}
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Total Projects</th>
                <th>Total Beams</th>
                <th>Last Activity</th>
            </tr>
        </thead>
        <tbody>
            {% for username, user_projects in users_with_projects %}
            <tr>
                <td><strong>{{ username }}</strong></td>
                <td>{{ user_projects|length }}</td>
                <td>-</td>
                <td>{{ user_projects|max(attribute='updated_at')|attr('updated_at')|default('Never', true)|string }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

{% endblock %}
