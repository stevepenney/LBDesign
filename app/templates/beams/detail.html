{% extends "base.html" %}

{% block title %}{{ beam.name }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1>{{ beam.name }}</h1>
        <p style="color: #666;">
            <a href="{{ url_for('projects.detail', project_id=project.id) }}">{{ project.name }}</a>
            {% if beam.reference %} - Reference: {{ beam.reference }}{% endif %}
        </p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('beams.edit', beam_id=beam.id) }}" class="btn btn-secondary">Edit Beam</a>
        <a href="{{ url_for('projects.detail', project_id=project.id) }}" class="btn btn-secondary">Back to Project</a>
    </div>
</div>

<!-- Member Properties Card -->
<div class="card">
    <h2>Member Properties</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div>
            <p><strong>Type:</strong> {{ beam.member_type|replace('_', ' ')|title }}</p>
        </div>
        <div>
            <p><strong>Span:</strong> {{ "%.2f"|format(beam.span) }} m</p>
        </div>
        <div>
            <p><strong>Spacing:</strong> {{ ("%.2f m"|format(beam.spacing)) if beam.spacing else 'N/A' }}</p>
        </div>
    </div>
</div>

<!-- Loading Card -->
<div class="card">
    <h2>Loading</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div>
            <p><strong>Dead Load:</strong> {{ ("%.2f"|format(beam.dead_load)) if beam.dead_load else '-' }} kPa</p>
        </div>
        <div>
            <p><strong>Live Load:</strong> {{ ("%.2f"|format(beam.live_load)) if beam.live_load else '-' }} kPa</p>
        </div>
        <div>
            <p><strong>Total UDL:</strong> {{ ("%.2f"|format(beam.total_udl)) if beam.total_udl else '-' }} kPa</p>
        </div>
    </div>
    
    {% if beam.point_load_1 or beam.point_load_2 %}
    <h3 class="mt-2">Point Loads</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        {% if beam.point_load_1 %}
        <div>
            <p><strong>Point Load 1:</strong> {{ "%.2f"|format(beam.point_load_1) }} kN 
               at {{ "%.2f"|format(beam.point_load_1_position) }} m</p>
        </div>
        {% endif %}
        
        {% if beam.point_load_2 %}
        <div>
            <p><strong>Point Load 2:</strong> {{ "%.2f"|format(beam.point_load_2) }} kN 
               at {{ "%.2f"|format(beam.point_load_2_position) }} m</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Calculate Button (if not calculated) or Re-calculate (if already calculated) -->
<div style="margin: 2rem 0;">
    {% if beam.is_calculated %}
    <form method="POST" action="{{ url_for('beams.calculate', beam_id=beam.id) }}" style="display: inline;">
        <button type="submit" class="btn btn-secondary">Re-calculate</button>
    </form>
    <span style="color: #666; margin-left: 1rem;">
        Last calculated: {{ beam.calc_date.strftime('%Y-%m-%d %H:%M') if beam.calc_date else 'Never' }}
    </span>
    {% else %}
    <form method="POST" action="{{ url_for('beams.calculate', beam_id=beam.id) }}" style="display: inline;">
        <button type="submit" class="btn btn-primary">Calculate</button>
    </form>
    <span style="color: #666; margin-left: 1rem;">This beam has not been calculated yet</span>
    {% endif %}
</div>

<!-- Calculation Results Card (only if calculated) -->
{% if beam.is_calculated %}
<div class="card">
    <h2>Calculation Results 
        <span style="background-color: 
            {% if beam.calc_status == 'PASS' %}#22c55e
            {% elif beam.calc_status == 'WARNING' %}#f59e0b
            {% else %}#ef4444{% endif %};
            color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 1rem; margin-left: 1rem;">
            {{ beam.calc_status }}
        </span>
    </h2>
    
    <!-- Results Table -->
    <table style="margin-top: 1.5rem;">
        <thead>
            <tr>
                <th></th>
                <th>Demand</th>
                <th>Capacity</th>
                <th>Utilization</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Bending:</strong></td>
                <td>{{ "%.2f"|format(beam.demand_moment) }} kNm</td>
                <td>{{ "%.2f"|format(beam.capacity_moment) }} kNm</td>
                <td>
                    <span style="font-weight: 600; color: 
                        {% if beam.utilization_moment < 0.9 %}#22c55e
                        {% elif beam.utilization_moment < 1.0 %}#f59e0b
                        {% else %}#ef4444{% endif %};">
                        {{ "%.1f"|format(beam.utilization_moment * 100) }}%
                    </span>
                </td>
                <td>
                    {% if beam.utilization_moment < 0.9 %}
                    <span style="color: #22c55e;">✓ OK</span>
                    {% elif beam.utilization_moment < 1.0 %}
                    <span style="color: #f59e0b;">⚠ Warning</span>
                    {% else %}
                    <span style="color: #ef4444;">✗ Fail</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>Shear:</strong></td>
                <td>{{ "%.2f"|format(beam.demand_shear) }} kN</td>
                <td>{{ "%.2f"|format(beam.capacity_shear) }} kN</td>
                <td>
                    <span style="font-weight: 600; color: 
                        {% if beam.utilization_shear < 0.9 %}#22c55e
                        {% elif beam.utilization_shear < 1.0 %}#f59e0b
                        {% else %}#ef4444{% endif %};">
                        {{ "%.1f"|format(beam.utilization_shear * 100) }}%
                    </span>
                </td>
                <td>
                    {% if beam.utilization_shear < 0.9 %}
                    <span style="color: #22c55e;">✓ OK</span>
                    {% elif beam.utilization_shear < 1.0 %}
                    <span style="color: #f59e0b;">⚠ Warning</span>
                    {% else %}
                    <span style="color: #ef4444;">✗ Fail</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>Deflection:</strong></td>
                <td>{{ "%.2f"|format(beam.demand_deflection) }} mm</td>
                <td>{{ "%.2f"|format(beam.deflection_limit) }} mm</td>
                <td>
                    <span style="font-weight: 600; color: 
                        {% if beam.utilization_deflection < 0.9 %}#22c55e
                        {% elif beam.utilization_deflection < 1.0 %}#f59e0b
                        {% else %}#ef4444{% endif %};">
                        {{ "%.1f"|format(beam.utilization_deflection * 100) }}%
                    </span>
                </td>
                <td>
                    {% if beam.utilization_deflection < 0.9 %}
                    <span style="color: #22c55e;">✓ OK</span>
                    {% elif beam.utilization_deflection < 1.0 %}
                    <span style="color: #f59e0b;">⚠ Warning</span>
                    {% else %}
                    <span style="color: #ef4444;">✗ Fail</span>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>
    
    <!-- Summary Info -->
    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #f3f4f6;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <p><strong>Controlling Factor:</strong> {{ beam.controlling_factor }}</p>
                <p><strong>Maximum Utilization:</strong> 
                    <span style="font-weight: 600; color: 
                        {% if beam.max_utilization < 0.9 %}#22c55e
                        {% elif beam.max_utilization < 1.0 %}#f59e0b
                        {% else %}#ef4444{% endif %};">
                        {{ "%.1f"|format(beam.max_utilization * 100) }}%
                    </span>
                </p>
            </div>
            <div>
                <p><strong>Calculated:</strong> {{ beam.calc_date.strftime('%Y-%m-%d %H:%M') }}</p>
                <p><strong>Calculation Version:</strong> {{ beam.calc_version }}</p>
            </div>
        </div>
    </div>
    
    <!-- Section Properties Used (from placeholder) -->
    <div style="margin-top: 1.5rem; padding: 1rem; background-color: #f9fafb; border-radius: 4px;">
        <p style="color: #666; font-size: 0.9rem; margin: 0;">
            <strong>Note:</strong> This calculation uses a placeholder 300x45 LVL section. 
            Product database integration coming in next phase.
        </p>
    </div>
</div>
{% else %}
<!-- Not yet calculated message -->
<div class="card" style="background-color: #eff6ff; border-left: 4px solid #3b82f6;">
    <p style="margin: 0; color: #1e40af;">
        <strong>ℹ️ Ready to Calculate</strong><br>
        Click the "Calculate" button above to analyze this beam and get product recommendations.
    </p>
</div>
{% endif %}

<!-- Delete Button -->
<div style="margin-top: 2rem;">
    <form method="POST" action="{{ url_for('beams.delete', beam_id=beam.id) }}" 
          onsubmit="return confirm('Are you sure you want to delete this beam?');">
        <button type="submit" class="btn btn-danger">Delete Beam</button>
    </form>
</div>
{% endblock %}
